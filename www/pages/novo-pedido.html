<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Sabor Express - Novo Pedido</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/sb-admin-2.css">
    <!-- API Script -->
    <script src="../js/api.js"></script>
</head>

<body>
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Sabor Express</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Gestão
            </div>

            <!-- Nav Item - Novo Pedido -->
            <li class="nav-item active">
                <a class="nav-link" href="novo-pedido.html">
                    <i class="fas fa-fw fa-shopping-cart"></i>
                    <span>Novo Pedido</span>
                </a>
            </li>

            <!-- Nav Item - Produtos -->
            <li class="nav-item">
                <a class="nav-link" href="produtos.html">
                    <i class="fas fa-fw fa-hamburger"></i>
                    <span>Produtos</span>
                </a>
            </li>

            <!-- Nav Item - Sabores -->
            <li class="nav-item">
                <a class="nav-link" href="sabores.html">
                    <i class="fas fa-fw fa-pizza-slice"></i>
                    <span>Sabores</span>
                </a>
            </li>

            <!-- Nav Item - Tamanhos -->
            <li class="nav-item">
                <a class="nav-link" href="tamanhos.html">
                    <i class="fas fa-fw fa-expand-arrows-alt"></i>
                    <span>Tamanhos</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Sistema
            </div>

            <!-- Nav Item - Configurações -->
            <li class="nav-item">
                <a class="nav-link" href="configuracoes.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Brand -->
                    <div class="topbar-brand">
                        <i class="fas fa-shopping-cart text-primary"></i> Novo Pedido
                    </div>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">
                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Administrador</span>
                                <i class="fas fa-user-circle fa-fw"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Criar Novo Pedido</h1>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" onclick="limparFormulario()">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                            <button type="button" class="btn btn-success" onclick="salvarPedido()">
                                <i class="fas fa-save"></i> Salvar Pedido
                            </button>
                        </div>
                    </div>

                    <form id="pedidoForm">
                        <div class="row">
                            <!-- Informações do Cliente -->
                            <div class="col-lg-6">
                                <div class="card shadow mb-4">
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="fas fa-user"></i> Informações do Cliente
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="nomeCliente" class="form-label">Nome do Cliente *</label>
                                            <input type="text" class="form-control" id="nomeCliente" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="telefoneCliente" class="form-label">Telefone *</label>
                                            <input type="tel" class="form-control" id="telefoneCliente" placeholder="(11) 99999-9999" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="enderecoCliente" class="form-label">Endereço Completo *</label>
                                            <textarea class="form-control" id="enderecoCliente" rows="3" placeholder="Rua, número, bairro, cidade" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="observacoesCliente" class="form-label">Observações</label>
                                            <textarea class="form-control" id="observacoesCliente" rows="2" placeholder="Ponto de referência, complemento..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detalhes do Pedido -->
                            <div class="col-lg-6">
                                <div class="card shadow mb-4">
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="fas fa-clipboard-list"></i> Detalhes do Pedido
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="formaPagamento" class="form-label">Forma de Pagamento *</label>
                                                <select class="form-select" id="formaPagamento" required>
                                                    <option value="">Selecione...</option>
                                                    <option value="PIX">PIX</option>
                                                    <option value="Dinheiro">Dinheiro</option>
                                                    <option value="Cartão de Crédito">Cartão de Crédito</option>
                                                    <option value="Cartão de Débito">Cartão de Débito</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="tipoEntrega" class="form-label">Tipo de Entrega *</label>
                                                <select class="form-select" id="tipoEntrega" required>
                                                    <option value="">Selecione...</option>
                                                    <option value="Entrega">Entrega</option>
                                                    <option value="Retirada">Retirada</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="dataEntrega" class="form-label">Data de Entrega</label>
                                                <input type="date" class="form-control" id="dataEntrega">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="horaEntrega" class="form-label">Hora de Entrega</label>
                                                <input type="time" class="form-control" id="horaEntrega">
                                            </div>
                                        </div>
                                        <div class="mb-3" id="trocoContainer" style="display: none;">
                                            <label for="valorTroco" class="form-label">Troco para quanto?</label>
                                            <input type="number" class="form-control" id="valorTroco" step="0.01" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Itens do Pedido -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-pizza-slice"></i> Itens do Pedido
                                </h6>
                                <button type="button" class="btn btn-primary btn-sm" onclick="adicionarItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="itensContainer">
                                    <!-- Itens serão adicionados dinamicamente -->
                                </div>
                                
                                <!-- Resumo do Pedido -->
                                <div class="row mt-4">
                                    <div class="col-md-8"></div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">Resumo do Pedido</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>Subtotal:</span>
                                                    <span id="subtotal">R$ 0,00</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Taxa de Entrega:</span>
                                                    <span id="taxaEntrega">R$ 0,00</span>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between font-weight-bold">
                                                    <span>Total:</span>
                                                    <span id="total">R$ 0,00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Sabor Express 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom scripts for all pages-->
    <script>
        // Toggle the side navigation
        (function($) {
            "use strict";

            $("#sidebarToggle, #sidebarToggleTop").on('click', function(e) {
                $("body").toggleClass("sidebar-toggled");
                $(".sidebar").toggleClass("toggled");
                if ($(".sidebar").hasClass("toggled")) {
                    $('.sidebar .collapse').collapse('hide');
                };
            });

            $(window).resize(function() {
                if ($(window).width() < 768) {
                    $('.sidebar .collapse').collapse('hide');
                };
                
                if ($(window).width() < 480 && !$(".sidebar").hasClass("toggled")) {
                    $("body").addClass("sidebar-toggled");
                    $(".sidebar").addClass("toggled");
                    $('.sidebar .collapse').collapse('hide');
                };
            });

        })(jQuery);

        // Dados de exemplo - serão carregados da API
        let produtos = [];
        let tamanhos = [];
        let sabores = [];

        let contadorItens = 0;
        let itens = [];

        // Carregar dados da API ao inicializar
        async function carregarDadosIniciais() {
            try {
                // Carregar produtos, tamanhos e sabores da API
                produtos = await api.getProdutos();
                tamanhos = await api.getTamanhos();
                sabores = await api.getSabores();
                
                console.log('Dados carregados:', { produtos: produtos.length, tamanhos: tamanhos.length, sabores: sabores.length });
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                alert('Erro ao carregar dados. Verifique se a API está funcionando.');
            }
        }

        // Mostrar/ocultar campo de troco
        document.getElementById('formaPagamento').addEventListener('change', function() {
            const trocoContainer = document.getElementById('trocoContainer');
            if (this.value === 'Dinheiro') {
                trocoContainer.style.display = 'block';
            } else {
                trocoContainer.style.display = 'none';
            }
        });

        // Atualizar taxa de entrega
        document.getElementById('tipoEntrega').addEventListener('change', function() {
            calcularTotal();
        });

        function adicionarItem() {
            contadorItens++;
            const itemHtml = `
                <div class="card mb-3" id="item-${contadorItens}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Item ${contadorItens}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${contadorItens})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Produto *</label>
                                <select class="form-select produto-select" data-item="${contadorItens}" required>
                                    <option value="">Selecione um produto...</option>
                                    ${produtos.map(p => `<option value="${p._id}" data-preco="${p.preco}" data-categoria="${p.categoria}">${p.nome} - R$ ${p.preco.toFixed(2)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3 tamanho-container" style="display: none;">
                                <label class="form-label">Tamanho</label>
                                <select class="form-select tamanho-select" data-item="${contadorItens}">
                                    <option value="">Selecione...</option>
                                    ${tamanhos.map(t => `<option value="${t._id}" data-multiplicador="${t.multiplicador}">${t.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3 sabor-container" style="display: none;">
                                <label class="form-label">Sabores (2-3 sabores)</label>
                                <div class="sabores-checkboxes" data-item="${contadorItens}">
                                    ${sabores.map(s => `
                                        <div class="form-check">
                                            <input class="form-check-input sabor-checkbox" type="checkbox" value="${s._id}" 
                                                   data-nome="${s.nome}" data-adicional="${s.precoAdicional}" 
                                                   id="sabor-${contadorItens}-${s._id}">
                                            <label class="form-check-label" for="sabor-${contadorItens}-${s._id}">
                                                ${s.nome}${s.precoAdicional > 0 ? ` (+R$ ${s.precoAdicional.toFixed(2)})` : ''}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                                <small class="text-muted">Selecione de 2 a 3 sabores para sua pizza</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Quantidade *</label>
                                <input type="number" class="form-control quantidade-input" data-item="${contadorItens}" min="1" value="1" required>
                            </div>
                            <div class="col-md-1 mb-3">
                                <label class="form-label">Preço</label>
                                <input type="text" class="form-control preco-item" data-item="${contadorItens}" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label">Observações</label>
                                <textarea class="form-control observacoes-item" data-item="${contadorItens}" rows="2" placeholder="Observações especiais para este item..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('itensContainer').insertAdjacentHTML('beforeend', itemHtml);
            
            // Adicionar event listeners
            const itemElement = document.getElementById(`item-${contadorItens}`);
            const produtoSelect = itemElement.querySelector('.produto-select');
            const tamanhoSelect = itemElement.querySelector('.tamanho-select');
            const saboresCheckboxes = itemElement.querySelectorAll('.sabor-checkbox');
            const quantidadeInput = itemElement.querySelector('.quantidade-input');
            
            produtoSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const categoria = selectedOption.dataset.categoria;
                const tamanhoContainer = itemElement.querySelector('.tamanho-container');
                const saborContainer = itemElement.querySelector('.sabor-container');
                
                if (categoria === 'Pizza') {
                    tamanhoContainer.style.display = 'block';
                    saborContainer.style.display = 'block';
                } else {
                    tamanhoContainer.style.display = 'none';
                    saborContainer.style.display = 'none';
                }
                
                calcularPrecoItem(contadorItens);
            });
            
            tamanhoSelect.addEventListener('change', () => calcularPrecoItem(contadorItens));
            
            // Event listeners para checkboxes de sabores
            saboresCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedBoxes = itemElement.querySelectorAll('.sabor-checkbox:checked');
                    
                    // Limitar seleção a 3 sabores
                    if (checkedBoxes.length > 3) {
                        this.checked = false;
                        alert('Você pode selecionar no máximo 3 sabores por pizza.');
                        return;
                    }
                    
                    calcularPrecoItem(contadorItens);
                });
            });
            
            quantidadeInput.addEventListener('input', () => calcularPrecoItem(contadorItens));
        }

        function removerItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            itens = itens.filter(item => item.id !== itemId);
            calcularTotal();
        }

        function calcularPrecoItem(itemId) {
            const itemElement = document.getElementById(`item-${itemId}`);
            const produtoSelect = itemElement.querySelector('.produto-select');
            const tamanhoSelect = itemElement.querySelector('.tamanho-select');
            const saboresCheckboxes = itemElement.querySelectorAll('.sabor-checkbox:checked');
            const quantidadeInput = itemElement.querySelector('.quantidade-input');
            const precoInput = itemElement.querySelector('.preco-item');
            
            if (!produtoSelect.value) {
                precoInput.value = '';
                return;
            }
            
            const produtoOption = produtoSelect.options[produtoSelect.selectedIndex];
            let precoBase = parseFloat(produtoOption.dataset.preco);
            
            // Aplicar multiplicador de tamanho se for pizza
            if (produtoOption.dataset.categoria === 'Pizza' && tamanhoSelect.value) {
                const tamanhoOption = tamanhoSelect.options[tamanhoSelect.selectedIndex];
                precoBase *= parseFloat(tamanhoOption.dataset.multiplicador);
            }
            
            // Adicionar preços dos sabores se for pizza
            if (produtoOption.dataset.categoria === 'Pizza' && saboresCheckboxes.length > 0) {
                // Verificar se tem pelo menos 2 sabores selecionados
                if (saboresCheckboxes.length < 2) {
                    precoInput.value = 'Selecione pelo menos 2 sabores';
                    return;
                }
                
                let adicionalSabores = 0;
                saboresCheckboxes.forEach(checkbox => {
                    adicionalSabores += parseFloat(checkbox.dataset.adicional) || 0;
                });
                precoBase += adicionalSabores;
            }
            
            const quantidade = parseInt(quantidadeInput.value) || 1;
            const precoTotal = precoBase * quantidade;
            
            precoInput.value = `R$ ${precoTotal.toFixed(2)}`;
            
            // Atualizar array de itens
            const itemIndex = itens.findIndex(item => item.id === itemId);
            
            // Coletar sabores selecionados
            const saboresSelecionados = Array.from(saboresCheckboxes).map(checkbox => ({
                id: checkbox.value,
                nome: checkbox.dataset.nome,
                adicional: parseFloat(checkbox.dataset.adicional) || 0
            }));
            
            const itemData = {
                id: itemId,
                produtoId: produtoSelect.value,
                produtoNome: produtoOption.text.split(' - ')[0],
                tamanhoId: tamanhoSelect.value,
                sabores: saboresSelecionados,
                quantidade: quantidade,
                precoUnitario: precoBase,
                precoTotal: precoTotal,
                observacoes: itemElement.querySelector('.observacoes-item').value
            };
            
            if (itemIndex >= 0) {
                itens[itemIndex] = itemData;
            } else {
                itens.push(itemData);
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            const subtotal = itens.reduce((sum, item) => sum + item.precoTotal, 0);
            const tipoEntrega = document.getElementById('tipoEntrega').value;
            const taxaEntrega = tipoEntrega === 'Entrega' ? 5.00 : 0.00;
            const total = subtotal + taxaEntrega;
            
            document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
            document.getElementById('taxaEntrega').textContent = `R$ ${taxaEntrega.toFixed(2)}`;
            document.getElementById('total').textContent = `R$ ${total.toFixed(2)}`;
        }

        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os dados do formulário?')) {
                document.getElementById('pedidoForm').reset();
                document.getElementById('itensContainer').innerHTML = '';
                itens = [];
                contadorItens = 0;
                calcularTotal();
                document.getElementById('trocoContainer').style.display = 'none';
            }
        }

        async function salvarPedido() {
            const nomeCliente = document.getElementById('nomeCliente').value;
            const telefoneCliente = document.getElementById('telefoneCliente').value;
            const enderecoCliente = document.getElementById('enderecoCliente').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const tipoEntrega = document.getElementById('tipoEntrega').value;
            
            if (!nomeCliente || !telefoneCliente || !enderecoCliente || !formaPagamento || !tipoEntrega) {
                alert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            
            if (itens.length === 0) {
                alert('Adicione pelo menos um item ao pedido.');
                return;
            }
            
            // Validar itens
            for (let item of itens) {
                if (!item.produtoId) {
                    alert('Todos os itens devem ter um produto selecionado.');
                    return;
                }
            }
            
            const subtotal = itens.reduce((sum, item) => sum + item.precoTotal, 0);
            const taxaEntrega = tipoEntrega === 'Entrega' ? 5.00 : 0.00;
            const total = subtotal + taxaEntrega;
            
            const pedidoData = {
                cliente: {
                    nome: nomeCliente,
                    telefone: telefoneCliente,
                    endereco: enderecoCliente,
                    observacoes: document.getElementById('observacoesCliente').value
                },
                itens: itens.map(item => {
                     const produto = produtos.find(p => p._id === item.produtoId);
                     return {
                         produto: item.produtoId,
                         produtoNome: produto ? produto.nome : 'Produto não encontrado',
                         tamanho: item.tamanhoId || null,
                         sabores: item.sabores || [],
                         quantidade: item.quantidade,
                         precoUnitario: item.precoUnitario,
                         precoTotal: item.precoTotal,
                         observacoes: item.observacoes
                     };
                 }),
                subtotal: subtotal,
                taxaEntrega: taxaEntrega,
                total: total,
                formaPagamento: formaPagamento,
                tipoEntrega: tipoEntrega,
                dataEntrega: document.getElementById('dataEntrega').value || null,
                horaEntrega: document.getElementById('horaEntrega').value || null,
                valorTroco: document.getElementById('valorTroco').value || null,
                status: 'Pendente'
            };
            
            try {
                const pedidoCriado = await api.criarPedido(pedidoData);
                console.log('Pedido criado:', pedidoCriado);
                alert(`Pedido #${pedidoCriado.numeroPedido} criado com sucesso!`);
                
                // Limpar formulário após salvar
                limparFormulario();
            } catch (error) {
                console.error('Erro ao criar pedido:', error);
                alert('Erro ao criar pedido. Tente novamente.');
            }
        }

        // Inicializar com um item
        document.addEventListener('DOMContentLoaded', async function() {
            await carregarDadosIniciais();
            adicionarItem();
        });
    </script>
</body>
</html>