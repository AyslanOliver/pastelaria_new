<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Sabor Express - Novo Pedido</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/sb-admin-2.css">
    <!-- API Configuration Script (deve ser carregado primeiro) -->
    <script src="../js/api-config.js"></script>
    <!-- API Script -->
    <script src="../js/api.js"></script>
</head>

<body>
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Sabor Express</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Gest√£o
            </div>

            <!-- Nav Item - Novo Pedido -->
            <li class="nav-item active">
                <a class="nav-link" href="novo-pedido.html">
                    <i class="fas fa-fw fa-shopping-cart"></i>
                    <span>Novo Pedido</span>
                </a>
            </li>

            <!-- Nav Item - Produtos -->
            <li class="nav-item">
                <a class="nav-link" href="produtos.html">
                    <i class="fas fa-fw fa-hamburger"></i>
                    <span>Produtos</span>
                </a>
            </li>

            <!-- Nav Item - Sabores -->
            <li class="nav-item">
                <a class="nav-link" href="sabores.html">
                    <i class="fas fa-fw fa-pizza-slice"></i>
                    <span>Sabores</span>
                </a>
            </li>

            <!-- Nav Item - Tamanhos -->
            <li class="nav-item">
                <a class="nav-link" href="tamanhos.html">
                    <i class="fas fa-fw fa-expand-arrows-alt"></i>
                    <span>Tamanhos</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Sistema
            </div>

            <!-- Nav Item - Configura√ß√µes -->
            <li class="nav-item">
                <a class="nav-link" href="configuracoes.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Brand -->
                    <div class="topbar-brand">
                        <i class="fas fa-shopping-cart text-primary"></i> Novo Pedido
                    </div>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">
                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Administrador</span>
                                <i class="fas fa-user-circle fa-fw"></i>
                            </a>
                        </li>
                    </ul>
                </nav>
                <!-- End of Topbar -->

                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Criar Novo Pedido</h1>
                        <div>
                            <button type="button" class="btn btn-secondary me-2" onclick="limparFormulario()">
                                <i class="fas fa-eraser"></i> Limpar
                            </button>
                            <button type="button" class="btn btn-success" onclick="salvarPedido()">
                                <i class="fas fa-save"></i> Salvar Pedido
                            </button>
                        </div>
                    </div>

                    <form id="pedidoForm">
                        <div class="row">
                            <!-- Informa√ß√µes do Cliente -->
                            <div class="col-lg-6">
                                <div class="card shadow mb-4">
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="fas fa-user"></i> Informa√ß√µes do Cliente
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label for="nomeCliente" class="form-label">Nome do Cliente *</label>
                                            <input type="text" class="form-control" id="nomeCliente" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="telefoneCliente" class="form-label">Telefone *</label>
                                            <input type="tel" class="form-control" id="telefoneCliente" placeholder="(11) 99999-9999" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="enderecoCliente" class="form-label">Endere√ßo Completo *</label>
                                            <textarea class="form-control" id="enderecoCliente" rows="3" placeholder="Rua, n√∫mero, bairro, cidade" required></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label for="observacoesCliente" class="form-label">Observa√ß√µes</label>
                                            <textarea class="form-control" id="observacoesCliente" rows="2" placeholder="Ponto de refer√™ncia, complemento..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Detalhes do Pedido -->
                            <div class="col-lg-6">
                                <div class="card shadow mb-4">
                                    <div class="card-header py-3">
                                        <h6 class="m-0 font-weight-bold text-primary">
                                            <i class="fas fa-clipboard-list"></i> Detalhes do Pedido
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="formaPagamento" class="form-label">Forma de Pagamento *</label>
                                                <select class="form-select" id="formaPagamento" required>
                                                    <option value="">Selecione...</option>
                                                    <option value="PIX">PIX</option>
                                                    <option value="Dinheiro">Dinheiro</option>
                                                    <option value="Cr√©dito">Cart√£o de Cr√©dito</option>
                                                    <option value="D√©bito">Cart√£o de D√©bito</option>
                                                    <option value="Cart√£o">Cart√£o (Gen√©rico)</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="tipoEntrega" class="form-label">Tipo de Entrega *</label>
                                                <select class="form-select" id="tipoEntrega" required>
                                                    <option value="">Selecione...</option>
                                                    <option value="Entrega">Entrega</option>
                                                    <option value="Balc√£o">Retirada no Balc√£o</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="col-md-6 mb-3">
                                                <label for="dataEntrega" class="form-label">Data de Entrega</label>
                                                <input type="date" class="form-control" id="dataEntrega">
                                            </div>
                                            <div class="col-md-6 mb-3">
                                                <label for="horaEntrega" class="form-label">Hora de Entrega</label>
                                                <input type="time" class="form-control" id="horaEntrega">
                                            </div>
                                        </div>
                                        <div class="mb-3" id="trocoContainer" style="display: none;">
                                            <label for="valorTroco" class="form-label">Troco para quanto?</label>
                                            <input type="number" class="form-control" id="valorTroco" step="0.01" placeholder="0.00">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Itens do Pedido -->
                        <div class="card shadow mb-4">
                            <div class="card-header py-3 d-flex justify-content-between align-items-center">
                                <h6 class="m-0 font-weight-bold text-primary">
                                    <i class="fas fa-pizza-slice"></i> Itens do Pedido
                                </h6>
                                <button type="button" class="btn btn-primary btn-sm" onclick="adicionarItem()">
                                    <i class="fas fa-plus"></i> Adicionar Item
                                </button>
                            </div>
                            <div class="card-body">
                                <div id="itensContainer">
                                    <!-- Itens ser√£o adicionados dinamicamente -->
                                </div>
                                
                                <!-- Resumo do Pedido -->
                                <div class="row mt-4">
                                    <div class="col-md-8"></div>
                                    <div class="col-md-4">
                                        <div class="card bg-light">
                                            <div class="card-body">
                                                <h6 class="card-title">Resumo do Pedido</h6>
                                                <div class="d-flex justify-content-between">
                                                    <span>Subtotal:</span>
                                                    <span id="subtotal">R$ 0,00</span>
                                                </div>
                                                <div class="d-flex justify-content-between">
                                                    <span>Taxa de Entrega:</span>
                                                    <span id="taxaEntrega">R$ 0,00</span>
                                                </div>
                                                <hr>
                                                <div class="d-flex justify-content-between font-weight-bold">
                                                    <span>Total:</span>
                                                    <span id="total">R$ 0,00</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Sabor Express 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom scripts for all pages-->
    <script>
        // Toggle the side navigation
        (function($) {
            "use strict";

            $("#sidebarToggle, #sidebarToggleTop").on('click', function(e) {
                $("body").toggleClass("sidebar-toggled");
                $(".sidebar").toggleClass("toggled");
                if ($(".sidebar").hasClass("toggled")) {
                    $('.sidebar .collapse').collapse('hide');
                };
            });

            $(window).resize(function() {
                if ($(window).width() < 768) {
                    $('.sidebar .collapse').collapse('hide');
                };
                
                if ($(window).width() < 480 && !$(".sidebar").hasClass("toggled")) {
                    $("body").addClass("sidebar-toggled");
                    $(".sidebar").addClass("toggled");
                    $('.sidebar .collapse').collapse('hide');
                };
            });

        })(jQuery);

        // Dados de exemplo - ser√£o carregados da API
        let produtos = [];
        let tamanhos = [];
        let sabores = [];

        let contadorItens = 0;
        let itens = [];

        // Carregar dados da API ao inicializar
        async function carregarDadosIniciais() {
            try {
                // Carregar produtos, tamanhos e sabores da API
                const produtosResponse = await api.getProdutos();
                const tamanhosResponse = await api.getTamanhos();
                const saboresResponse = await api.getSabores();
                
                produtos = produtosResponse.data || produtosResponse;
                tamanhos = tamanhosResponse.data || tamanhosResponse;
                sabores = saboresResponse.data || saboresResponse;
                
                console.log('Dados carregados:', { produtos: produtos.length, tamanhos: tamanhos.length, sabores: sabores.length });
            } catch (error) {
                console.error('Erro ao carregar dados iniciais:', error);
                alert('Erro ao carregar dados. Verifique se a API est√° funcionando.');
            }
        }

        // Mostrar/ocultar campo de troco
        document.getElementById('formaPagamento').addEventListener('change', function() {
            const trocoContainer = document.getElementById('trocoContainer');
            if (this.value === 'Dinheiro') {
                trocoContainer.style.display = 'block';
            } else {
                trocoContainer.style.display = 'none';
            }
        });

        // Atualizar taxa de entrega
        document.getElementById('tipoEntrega').addEventListener('change', function() {
            calcularTotal();
        });

        function adicionarItem() {
            contadorItens++;
            const itemHtml = `
                <div class="card mb-3" id="item-${contadorItens}">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">Item ${contadorItens}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="removerItem(${contadorItens})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Produto *</label>
                                <select class="form-select produto-select" data-item="${contadorItens}" required>
                                    <option value="">Selecione um produto...</option>
                                    ${produtos.map(p => `<option value="${p.id}" data-preco="${p.preco}" data-categoria="${p.categoria}">${p.nome} - R$ ${p.preco.toFixed(2)}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-2 mb-3 tamanho-container" style="display: none;">
                                <label class="form-label">Tamanho</label>
                                <select class="form-select tamanho-select" data-item="${contadorItens}">
                                    <option value="">Selecione...</option>
                                    ${tamanhos.map(t => `<option value="${t.id}" data-multiplicador="${t.multiplicador}">${t.nome}</option>`).join('')}
                                </select>
                            </div>
                            <div class="col-md-3 mb-3 sabor-container" style="display: none;">
                                <label class="form-label">Sabores (2-3 sabores)</label>
                                <div class="sabores-checkboxes" data-item="${contadorItens}">
                                    ${sabores.map(s => `
                                        <div class="form-check">
                                            <input class="form-check-input sabor-checkbox" type="checkbox" value="${s.id}" 
                                                   data-nome="${s.nome}" data-adicional="${s.precoAdicional}" 
                                                   id="sabor-${contadorItens}-${s.id}">
                                            <label class="form-check-label" for="sabor-${contadorItens}-${s.id}">
                                                ${s.nome}${s.precoAdicional > 0 ? ` (+R$ ${s.precoAdicional.toFixed(2)})` : ''}
                                            </label>
                                        </div>
                                    `).join('')}
                                </div>
                                <small class="text-muted">Selecione de 2 a 3 sabores para sua pizza</small>
                            </div>
                            <div class="col-md-2 mb-3">
                                <label class="form-label">Quantidade *</label>
                                <input type="number" class="form-control quantidade-input" data-item="${contadorItens}" min="1" value="1" required>
                            </div>
                            <div class="col-md-1 mb-3">
                                <label class="form-label">Pre√ßo</label>
                                <input type="text" class="form-control preco-item" data-item="${contadorItens}" readonly>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="form-label">Observa√ß√µes</label>
                                <textarea class="form-control observacoes-item" data-item="${contadorItens}" rows="2" placeholder="Observa√ß√µes especiais para este item..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('itensContainer').insertAdjacentHTML('beforeend', itemHtml);
            
            // Adicionar event listeners
            const itemElement = document.getElementById(`item-${contadorItens}`);
            const produtoSelect = itemElement.querySelector('.produto-select');
            const tamanhoSelect = itemElement.querySelector('.tamanho-select');
            const saboresCheckboxes = itemElement.querySelectorAll('.sabor-checkbox');
            const quantidadeInput = itemElement.querySelector('.quantidade-input');
            
            produtoSelect.addEventListener('change', function() {
                const selectedOption = this.options[this.selectedIndex];
                const categoria = selectedOption.dataset.categoria;
                const tamanhoContainer = itemElement.querySelector('.tamanho-container');
                const saborContainer = itemElement.querySelector('.sabor-container');
                
                if (categoria === 'Pizza') {
                    tamanhoContainer.style.display = 'block';
                    saborContainer.style.display = 'block';
                } else {
                    tamanhoContainer.style.display = 'none';
                    saborContainer.style.display = 'none';
                }
                
                calcularPrecoItem(contadorItens);
            });
            
            tamanhoSelect.addEventListener('change', () => calcularPrecoItem(contadorItens));
            
            // Event listeners para checkboxes de sabores
            saboresCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const checkedBoxes = itemElement.querySelectorAll('.sabor-checkbox:checked');
                    
                    // Limitar sele√ß√£o a 3 sabores
                    if (checkedBoxes.length > 3) {
                        this.checked = false;
                        alert('Voc√™ pode selecionar no m√°ximo 3 sabores por pizza.');
                        return;
                    }
                    
                    calcularPrecoItem(contadorItens);
                });
            });
            
            quantidadeInput.addEventListener('input', () => calcularPrecoItem(contadorItens));
        }

        function removerItem(itemId) {
            document.getElementById(`item-${itemId}`).remove();
            itens = itens.filter(item => item.id !== itemId);
            calcularTotal();
        }

        function calcularPrecoItem(itemId) {
            const itemElement = document.getElementById(`item-${itemId}`);
            const produtoSelect = itemElement.querySelector('.produto-select');
            const tamanhoSelect = itemElement.querySelector('.tamanho-select');
            const saboresCheckboxes = itemElement.querySelectorAll('.sabor-checkbox:checked');
            const quantidadeInput = itemElement.querySelector('.quantidade-input');
            const precoInput = itemElement.querySelector('.preco-item');
            
            if (!produtoSelect.value) {
                precoInput.value = '';
                return;
            }
            
            const produtoOption = produtoSelect.options[produtoSelect.selectedIndex];
            let precoBase = parseFloat(produtoOption.dataset.preco);
            
            // Aplicar multiplicador de tamanho se for pizza
            if (produtoOption.dataset.categoria === 'Pizza' && tamanhoSelect.value) {
                const tamanhoOption = tamanhoSelect.options[tamanhoSelect.selectedIndex];
                precoBase *= parseFloat(tamanhoOption.dataset.multiplicador);
            }
            
            // Adicionar pre√ßos dos sabores se for pizza
            if (produtoOption.dataset.categoria === 'Pizza' && saboresCheckboxes.length > 0) {
                // Verificar se tem pelo menos 2 sabores selecionados
                if (saboresCheckboxes.length < 2) {
                    precoInput.value = 'Selecione pelo menos 2 sabores';
                    return;
                }
                
                let adicionalSabores = 0;
                saboresCheckboxes.forEach(checkbox => {
                    adicionalSabores += parseFloat(checkbox.dataset.adicional) || 0;
                });
                precoBase += adicionalSabores;
            }
            
            const quantidade = parseInt(quantidadeInput.value) || 1;
            const precoTotal = precoBase * quantidade;
            
            precoInput.value = `R$ ${precoTotal.toFixed(2)}`;
            
            // Atualizar array de itens
            const itemIndex = itens.findIndex(item => item.id === itemId);
            
            // Coletar sabores selecionados
            const saboresSelecionados = Array.from(saboresCheckboxes).map(checkbox => ({
                id: checkbox.value,
                nome: checkbox.dataset.nome,
                adicional: parseFloat(checkbox.dataset.adicional) || 0
            }));
            
            const itemData = {
                id: itemId,
                produtoId: produtoSelect.value,
                produtoNome: produtoOption.text.split(' - ')[0],
                tamanhoId: tamanhoSelect.value,
                sabores: saboresSelecionados,
                quantidade: quantidade,
                precoUnitario: precoBase,
                precoTotal: precoTotal,
                observacoes: itemElement.querySelector('.observacoes-item').value
            };
            
            if (itemIndex >= 0) {
                itens[itemIndex] = itemData;
            } else {
                itens.push(itemData);
            }
            
            calcularTotal();
        }

        function calcularTotal() {
            const subtotal = itens.reduce((sum, item) => sum + item.precoTotal, 0);
            const tipoEntrega = document.getElementById('tipoEntrega').value;
            const taxaEntrega = tipoEntrega === 'Entrega' ? 5.00 : 0.00;
            const total = subtotal + taxaEntrega;
            
            document.getElementById('subtotal').textContent = `R$ ${subtotal.toFixed(2)}`;
            document.getElementById('taxaEntrega').textContent = `R$ ${taxaEntrega.toFixed(2)}`;
            document.getElementById('total').textContent = `R$ ${total.toFixed(2)}`;
        }

        function limparFormulario() {
            if (confirm('Tem certeza que deseja limpar todos os dados do formul√°rio?')) {
                document.getElementById('pedidoForm').reset();
                document.getElementById('itensContainer').innerHTML = '';
                itens = [];
                contadorItens = 0;
                calcularTotal();
                document.getElementById('trocoContainer').style.display = 'none';
            }
        }

        async function salvarPedido() {
            const nomeCliente = document.getElementById('nomeCliente').value;
            const telefoneCliente = document.getElementById('telefoneCliente').value;
            const enderecoCliente = document.getElementById('enderecoCliente').value;
            const formaPagamento = document.getElementById('formaPagamento').value;
            const tipoEntrega = document.getElementById('tipoEntrega').value;
            
            if (!nomeCliente || !telefoneCliente || !enderecoCliente || !formaPagamento || !tipoEntrega) {
                alert('Por favor, preencha todos os campos obrigat√≥rios.');
                return;
            }
            
            if (itens.length === 0) {
                alert('Adicione pelo menos um item ao pedido.');
                return;
            }
            
            // Validar itens
            for (let item of itens) {
                if (!item.produtoId) {
                    alert('Todos os itens devem ter um produto selecionado.');
                    return;
                }
            }
            
            const subtotal = itens.reduce((sum, item) => sum + item.precoTotal, 0);
            const taxaEntrega = tipoEntrega === 'Entrega' ? 5.00 : 0.00;
            const total = subtotal + taxaEntrega;
            
            const pedidoData = {
                cliente_nome: nomeCliente,
                cliente_telefone: telefoneCliente,
                cliente_endereco: enderecoCliente,
                observacoes: document.getElementById('observacoesCliente').value,
                itens: itens.map(item => {
                     const produto = produtos.find(p => p.id === item.produtoId);
                     return {
                         produto_id: parseInt(item.produtoId),
                         quantidade: item.quantidade,
                         preco_unitario: item.precoUnitario,
                         tamanho_id: item.tamanhoId ? parseInt(item.tamanhoId) : null,
                         sabores: item.sabores || []
                     };
                 }),
                subtotal: subtotal,
                taxa_entrega: taxaEntrega,
                total: total,
                forma_pagamento: formaPagamento,
                tipo_entrega: tipoEntrega,
                data_entrega: document.getElementById('dataEntrega').value || null,
                hora_entrega: document.getElementById('horaEntrega').value || null,
                valor_troco: document.getElementById('valorTroco').value || null,
                status: 'Pendente'
            };
            
            try {
                const response = await api.criarPedido(pedidoData);
                console.log('Resposta da API:', response);
                
                // A API retorna { success: true, data: { pedido completo } }
                const pedidoCriado = response.data;
                console.log('Pedido criado:', pedidoCriado);
                
                // Mostrar mensagem de sucesso
                alert(`Pedido #${pedidoCriado.numero} criado com sucesso!`);
                
                // Gerar mensagem do WhatsApp e imprimir comanda
                gerarMensagemWhatsAppNovoPedido(pedidoCriado);
                imprimirComandaCozinhaNovoPedido(pedidoCriado);
                
                // Limpar formul√°rio ap√≥s salvar
                limparFormulario();
            } catch (error) {
                console.error('Erro ao criar pedido:', error);
                alert('Erro ao criar pedido. Tente novamente.');
            }
        }

        // Fun√ß√£o para gerar mensagem do WhatsApp ap√≥s criar novo pedido
        function gerarMensagemWhatsAppNovoPedido(pedido) {
            if (!pedido) return;

            // Obter dados do cliente
            const nomeCliente = pedido.cliente?.nome || 'Cliente n√£o informado';
            const telefoneCliente = pedido.cliente?.telefone || '';
            const enderecoCliente = pedido.cliente?.endereco || 'Endere√ßo n√£o informado';
            const formaPagamento = pedido.formaPagamento || 'PIX';
            
            // Calcular subtotal dos itens
            let subtotalItens = 0;
            let itensTexto = '';
            
            pedido.itens.forEach((item, index) => {
                // Usar precoUnitario se dispon√≠vel, sen√£o usar preco
                let preco = 0;
                if (item.precoUnitario !== undefined && item.precoUnitario !== null) {
                    preco = parseFloat(item.precoUnitario);
                } else if (item.preco !== undefined && item.preco !== null) {
                    preco = parseFloat(item.preco);
                } else if (item.precoTotal && item.quantidade) {
                    preco = parseFloat(item.precoTotal) / parseFloat(item.quantidade);
                }
                
                const quantidade = parseInt(item.quantidade) || 1;
                const subtotalItem = quantidade * preco;
                subtotalItens += subtotalItem;
                
                // Obter sabores corretamente
                let saboresTexto = '';
                if (item.sabores && Array.isArray(item.sabores) && item.sabores.length > 0) {
                    const saboresNomes = item.sabores.map(sabor => {
                        if (typeof sabor === 'object' && sabor.nome) {
                            return sabor.nome;
                        } else if (typeof sabor === 'string') {
                            return sabor;
                        }
                        return '';
                    }).filter(nome => nome);
                    
                    if (saboresNomes.length > 0) {
                        saboresTexto = ` - ${saboresNomes.join(', ')}`;
                    }
                } else if (item.sabor) {
                    saboresTexto = ` - ${item.sabor}`;
                }
                
                const tamanhoInfo = item.tamanho ? ` (${item.tamanho})` : '';
                
                // Obter nome do produto corretamente
                let nomeProduto = 'Produto n√£o informado';
                if (item.produtoNome) {
                    nomeProduto = item.produtoNome;
                } else if (item.produto) {
                    if (typeof item.produto === 'object' && item.produto.nome) {
                        nomeProduto = item.produto.nome;
                    } else if (typeof item.produto === 'string') {
                        nomeProduto = item.produto;
                    }
                }
                
                itensTexto += `${index + 1}. ${nomeProduto}${saboresTexto}${tamanhoInfo}\n`;
                itensTexto += `   Qtd: ${quantidade}x R$ ${preco.toFixed(2).replace('.', ',')}\n`;
                itensTexto += `   Subtotal: R$ ${subtotalItem.toFixed(2).replace('.', ',')}\n\n`;
            });
            
            // Calcular taxa de delivery
            const taxaEntrega = pedido.taxaEntrega || pedido.taxaDelivery || 5.00;
            const total = pedido.total || (subtotalItens + taxaEntrega);
            
            // Formatar data
            const dataFormatada = new Date().toLocaleString('pt-BR');
            
            const mensagem = `üçï *NOVO PEDIDO CRIADO #${pedido.numero || pedido.numeroPedido || 'N/A'}*\n\n` +
                           `üë§ *Cliente:* ${nomeCliente}\n` +
                           `üìû *Telefone:* ${telefoneCliente}\n` +
                           `üìç *Endere√ßo:* ${enderecoCliente}\n` +
                           `üí≥ *Pagamento:* ${formaPagamento}\n\n` +
                           `üìã *Itens:*\n${itensTexto}` +
                           `üí∞ *Subtotal:* R$ ${subtotalItens.toFixed(2).replace('.', ',')}\n` +
                           `üöö *Taxa de Entrega:* R$ ${taxaEntrega.toFixed(2).replace('.', ',')}\n` +
                           `üíµ *Total:* R$ ${total.toFixed(2).replace('.', ',')}\n\n` +
                           `üìÖ *Data:* ${dataFormatada}\n\n` +
                           `‚úÖ *Pedido criado com sucesso!*\n` +
                           `üçï *Comanda da cozinha foi impressa automaticamente*\n\n` +
                           `Obrigado pela prefer√™ncia! üçï‚ú®`;

            // Mostrar mensagem na tela ao inv√©s de abrir WhatsApp
            mostrarMensagemWhatsApp(mensagem, telefoneCliente);
        }

        // Fun√ß√£o para imprimir comanda da cozinha ap√≥s criar novo pedido
        function imprimirComandaCozinhaNovoPedido(pedido) {
            if (!pedido) return;
            
            const dataFormatada = new Date().toLocaleString('pt-BR');
            
            // Obter dados do cliente
            const nomeCliente = pedido.cliente?.nome || 'Cliente n√£o informado';
            const telefoneCliente = pedido.cliente?.telefone || '';
            const enderecoCliente = pedido.cliente?.endereco || 'Endere√ßo n√£o informado';
            
            let comandaHtml = `
                <div style="width: 300px; margin: 0 auto; font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.4;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <div style="font-size: 16px; font-weight: bold;">üçï PASTELARIA</div>
                        <div style="font-size: 14px; font-weight: bold; margin-top: 5px;">COMANDA DA COZINHA</div>
                        <div style="font-size: 12px; margin-top: 5px;">Pedido #${pedido.numero || pedido.numeroPedido || 'N/A'}</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="font-weight: bold;">CLIENTE:</div>
                        <div>${nomeCliente}</div>
                        <div>Tel: ${telefoneCliente}</div>
                        <div style="font-size: 11px; margin-top: 5px;">${enderecoCliente}</div>
                    </div>
                    
                    <div style="border-bottom: 1px solid #000; margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">ITENS:</div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
            `;
            
            pedido.itens.forEach((item, index) => {
                // Obter sabores
                let saboresTexto = '';
                if (item.sabores && Array.isArray(item.sabores) && item.sabores.length > 0) {
                    const saboresNomes = item.sabores.map(sabor => {
                        if (typeof sabor === 'object' && sabor.nome) {
                            return sabor.nome;
                        } else if (typeof sabor === 'string') {
                            return sabor;
                        }
                        return '';
                    }).filter(nome => nome);
                    
                    if (saboresNomes.length > 0) {
                        saboresTexto = saboresNomes.join(', ');
                    }
                } else if (item.sabor) {
                    saboresTexto = item.sabor;
                }
                
                const tamanhoInfo = item.tamanho ? ` (${item.tamanho})` : '';
                
                // Obter nome do produto
                let nomeProduto = 'Produto n√£o informado';
                if (item.produtoNome) {
                    nomeProduto = item.produtoNome;
                } else if (item.produto) {
                    if (typeof item.produto === 'object' && item.produto.nome) {
                        nomeProduto = item.produto.nome;
                    } else if (typeof item.produto === 'string') {
                        nomeProduto = item.produto;
                    }
                }
                
                comandaHtml += `
                        <div style="border: 1px solid #000; padding: 8px; margin-bottom: 8px;">
                            <div style="font-weight: bold; font-size: 13px;">${index + 1}. ${nomeProduto}${tamanhoInfo}</div>
                            ${saboresTexto ? `<div style="margin-top: 3px;"><strong>Sabores:</strong> ${saboresTexto}</div>` : ''}
                            <div style="margin-top: 3px;"><strong>Quantidade:</strong> ${item.quantidade || 1}</div>
                            ${item.observacoes ? `<div style="margin-top: 3px;"><strong>Obs:</strong> ${item.observacoes}</div>` : ''}
                        </div>
                `;
            });
            
            comandaHtml += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 10px; border-top: 2px solid #000;">
                        <div style="font-size: 14px; font-weight: bold;">TOTAL: R$ ${(pedido.total || 0).toFixed(2).replace('.', ',')}</div>
                        <div style="font-size: 12px; margin-top: 5px;">Pagamento: ${pedido.formaPagamento || 'N/I'}</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; font-size: 10px;">
                        <div>Impresso em: ${dataFormatada}</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px;">
                        <div style="font-size: 11px;">
                            <div>‚ö†Ô∏è ATEN√á√ÉO COZINHA ‚ö†Ô∏è</div>
                            <div>‚úì Verificar todos os ingredientes</div>
                            <div>‚úì Conferir sabores e tamanhos</div>
                            <div>‚úì Pedido NOVO - Prioridade!</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Criar nova janela para impress√£o
            const janelaImpressao = window.open('', '_blank', 'width=400,height=600');
            janelaImpressao.document.write(
                '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '<title>Comanda da Cozinha - Pedido ' + (pedido.numero || pedido.numeroPedido || 'N/A') + '</title>' +
                '<style>' +
                '@media print {' +
                'body { margin: 0; }' +
                '@page { margin: 10mm; }' +
                '}' +
                'body {' +
                'font-family: "Courier New", monospace;' +
                'font-size: 12px;' +
                'line-height: 1.4;' +
                'margin: 0;' +
                'padding: 10px;' +
                'background: white;' +
                '}' +
                '</style>' +
                '</head>' +
                '<body>' +
                comandaHtml +
                '<scr' + 'ipt>' +
                'window.onload = function() {' +
                'window.print();' +
                'setTimeout(function() {' +
                'window.close();' +
                '}, 1000);' +
                '}' +
                '</scr' + 'ipt>' +
                '</body>' +
                '</html>'
            );
            janelaImpressao.document.close();
        }

        // Fun√ß√£o para mostrar mensagem do WhatsApp na tela
        function mostrarMensagemWhatsApp(mensagem, telefone) {
            // Criar modal se n√£o existir
            let modal = document.getElementById('modalWhatsApp');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modalWhatsApp';
                modal.className = 'modal fade';
                modal.setAttribute('tabindex', '-1');
                modal.setAttribute('aria-labelledby', 'modalWhatsAppLabel');
                modal.setAttribute('aria-hidden', 'true');
                
                modal.innerHTML = `
                    <div class="modal-dialog modal-lg">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title" id="modalWhatsAppLabel">
                                    <i class="fab fa-whatsapp me-2"></i>Mensagem do WhatsApp
                                </h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Instru√ß√µes:</strong> Copie a mensagem abaixo e cole no WhatsApp do cliente.
                                </div>
                                <div class="mb-3">
                                    <label for="telefoneCliente" class="form-label">
                                        <i class="fas fa-phone me-1"></i>Telefone do Cliente:
                                    </label>
                                    <input type="text" class="form-control" id="telefoneCliente" readonly>
                                </div>
                                <div class="mb-3">
                                    <label for="mensagemWhatsApp" class="form-label">
                                        <i class="fab fa-whatsapp me-1"></i>Mensagem:
                                    </label>
                                    <textarea class="form-control" id="mensagemWhatsApp" rows="15" readonly style="font-family: monospace; white-space: pre-wrap;"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times me-1"></i>Fechar
                                </button>
                                <button type="button" class="btn btn-success" id="copiarMensagem">
                                    <i class="fas fa-copy me-1"></i>Copiar Mensagem
                                </button>
                                <button type="button" class="btn btn-primary" id="abrirWhatsApp">
                                    <i class="fab fa-whatsapp me-1"></i>Abrir WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Adicionar evento para copiar mensagem
                document.getElementById('copiarMensagem').addEventListener('click', function() {
                    const textarea = document.getElementById('mensagemWhatsApp');
                    textarea.select();
                    textarea.setSelectionRange(0, 99999); // Para dispositivos m√≥veis
                    
                    try {
                        document.execCommand('copy');
                        
                        // Feedback visual
                        const btn = this;
                        const textoOriginal = btn.innerHTML;
                        btn.innerHTML = '<i class="fas fa-check me-1"></i>Copiado!';
                        btn.classList.remove('btn-success');
                        btn.classList.add('btn-success');
                        
                        setTimeout(() => {
                            btn.innerHTML = textoOriginal;
                            btn.classList.remove('btn-success');
                            btn.classList.add('btn-success');
                        }, 2000);
                        
                        // Mostrar toast de sucesso
                        mostrarToast('Mensagem copiada para a √°rea de transfer√™ncia!', 'success');
                    } catch (err) {
                        mostrarToast('Erro ao copiar mensagem. Selecione e copie manualmente.', 'error');
                    }
                });
                
                // Adicionar evento para abrir WhatsApp
                document.getElementById('abrirWhatsApp').addEventListener('click', function() {
                    const telefoneInput = document.getElementById('telefoneCliente');
                    const mensagemTextarea = document.getElementById('mensagemWhatsApp');
                    
                    const numeroWhatsApp = telefoneInput.value.replace(/\D/g, '');
                    const mensagemCodificada = encodeURIComponent(mensagemTextarea.value);
                    
                    if (numeroWhatsApp && numeroWhatsApp.length >= 10) {
                        const linkWhatsApp = `https://wa.me/55${numeroWhatsApp}?text=${mensagemCodificada}`;
                        window.open(linkWhatsApp, '_blank');
                    } else {
                        mostrarToast('N√∫mero de telefone inv√°lido!', 'error');
                    }
                });
            }
            
            // Preencher dados no modal
            document.getElementById('telefoneCliente').value = telefone || 'N√£o informado';
            document.getElementById('mensagemWhatsApp').value = mensagem;
            
            // Mostrar modal
            const modalBootstrap = new bootstrap.Modal(modal);
            modalBootstrap.show();
        }

        // Fun√ß√£o para mostrar toast de feedback
        function mostrarToast(mensagem, tipo = 'info') {
            // Criar container de toast se n√£o existir
            let toastContainer = document.getElementById('toastContainer');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toastContainer';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '9999';
                document.body.appendChild(toastContainer);
            }
            
            // Criar toast
            const toastId = 'toast_' + Date.now();
            const toastHtml = `
                <div id="${toastId}" class="toast align-items-center text-white bg-${tipo === 'success' ? 'success' : tipo === 'error' ? 'danger' : 'info'} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'error' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                            ${mensagem}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Mostrar toast
            const toastElement = document.getElementById(toastId);
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: 3000
            });
            toast.show();
            
            // Remover toast ap√≥s ser ocultado
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }

        // Inicializar com um item
        document.addEventListener('DOMContentLoaded', async function() {
            await carregarDadosIniciais();
            adicionarItem();
        });
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>