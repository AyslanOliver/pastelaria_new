<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>Sabor Express - Gest√£o de Pedidos</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@200;300;400;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="../css/sb-admin-2.css">`n    <!-- Mobile Responsive CSS -->`n    <link rel="stylesheet" href="../css/mobile-responsive.css">
    <!-- API Script -->
    <script src="../js/api-config.js"></script>
    <script src="../js/api.js"></script>
    
    <style>
        .status-badge {
            font-size: 0.8rem;
            padding: 0.4rem 0.8rem;
        }
        .order-card {
            transition: all 0.3s ease;
            border-left: 4px solid #dee2e6;
        }
        .order-card.pendente {
            border-left-color: #007bff;
        }
        .order-card.preparando {
            border-left-color: #ffc107;
        }
        .order-card.pronto {
            border-left-color: #17a2b8;
        }
        .order-card.entregue {
            border-left-color: #28a745;
        }
        .order-card.cancelado {
            border-left-color: #dc3545;
        }
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-action {
            margin: 0.2rem;
        }
        .order-items {
            font-size: 0.9rem;
        }
        .print-area {
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-area, .print-area * {
                visibility: visible;
            }
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
        }
    </style>
</head>

<body>
    <!-- Page Wrapper -->
    <div id="wrapper">
        <!-- Sidebar -->
        <ul class="navbar-nav sidebar sidebar-dark accordion" id="accordionSidebar">
            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="index.html">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-utensils"></i>
                </div>
                <div class="sidebar-brand-text mx-3">Sabor Express</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">

            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="index.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Gest√£o
            </div>

            <!-- Nav Item - Novo Pedido -->
            <li class="nav-item">
                <a class="nav-link" href="novo-pedido.html">
                    <i class="fas fa-fw fa-shopping-cart"></i>
                    <span>Novo Pedido</span>
                </a>
            </li>

            <!-- Nav Item - Gest√£o de Pedidos -->
            <li class="nav-item active">
                <a class="nav-link" href="gestao-pedidos.html">
                    <i class="fas fa-fw fa-clipboard-list"></i>
                    <span>Gest√£o de Pedidos</span>
                </a>
            </li>

            <!-- Nav Item - Produtos -->
            <li class="nav-item">
                <a class="nav-link" href="produtos.html">
                    <i class="fas fa-fw fa-hamburger"></i>
                    <span>Produtos</span>
                </a>
            </li>

            <!-- Nav Item - Sabores -->
            <li class="nav-item">
                <a class="nav-link" href="sabores.html">
                    <i class="fas fa-fw fa-pizza-slice"></i>
                    <span>Sabores</span>
                </a>
            </li>

            <!-- Nav Item - Tamanhos -->
            <li class="nav-item">
                <a class="nav-link" href="tamanhos.html">
                    <i class="fas fa-fw fa-expand-arrows-alt"></i>
                    <span>Tamanhos</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider">

            <!-- Heading -->
            <div class="sidebar-heading">
                Sistema
            </div>

            <!-- Nav Item - Configura√ß√µes -->
            <li class="nav-item">
                <a class="nav-link" href="configuracoes.html">
                    <i class="fas fa-fw fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </li>

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>
        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">
            <!-- Main Content -->
            <div id="content">
                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Brand -->
                    <div class="topbar-brand">
                        <i class="fas fa-clipboard-list text-primary"></i> Gest√£o de Pedidos
                    </div>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">
                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-bs-toggle="dropdown">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Administrador</span>
                                <i class="fas fa-user-circle fa-fw"></i>
                            </a>
                        </li>
                    </ul>
                </nav>

                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Gest√£o de Pedidos</h1>
                        <div>
                            <button class="btn btn-primary btn-sm" onclick="carregarPedidos()">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                        </div>
                    </div>

                    <!-- Filtros -->
                    <div class="row mb-4">
                        <div class="col-md-3">
                            <select class="form-select" id="filtroStatus" onchange="filtrarPedidos()">
                                <option value="">Todos os Status</option>
                                <option value="Pendente">Pendente</option>
                                <option value="Preparando">Preparando</option>
                                <option value="Pronto">Pronto</option>
                                <option value="Entregue">Entregue</option>
                                <option value="Cancelado">Cancelado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <input type="date" class="form-control" id="filtroData" onchange="filtrarPedidos()">
                        </div>
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="filtroCliente" placeholder="Buscar por cliente..." onkeyup="filtrarPedidos()">
                        </div>
                    </div>

                    <!-- Loading -->
                    <div id="loading" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando pedidos...</p>
                    </div>

                    <!-- Lista de Pedidos -->
                    <div id="pedidosContainer" class="row" style="display: none;">
                        <!-- Pedidos ser√£o carregados aqui dinamicamente -->
                    </div>

                    <!-- Mensagem quando n√£o h√° pedidos -->
                    <div id="noPedidos" class="text-center py-5" style="display: none;">
                        <i class="fas fa-clipboard-list fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">Nenhum pedido encontrado</h5>
                        <p class="text-muted">N√£o h√° pedidos que correspondam aos filtros selecionados.</p>
                    </div>
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; Sabor Express 2024</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->
        </div>
        <!-- End of Content Wrapper -->
    </div>
    <!-- End of Page Wrapper -->

    <!-- √Årea de Impress√£o (oculta) -->
    <div class="print-area" id="printArea">
        <!-- Conte√∫do da comanda ser√° inserido aqui -->
    </div>

    <!-- Modal de Confirma√ß√£o -->
    <div class="modal fade" id="confirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Confirmar A√ß√£o</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="confirmMessage">Tem certeza que deseja realizar esta a√ß√£o?</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirmButton">Confirmar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal WhatsApp -->
    <div class="modal fade" id="whatsappModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fab fa-whatsapp text-success"></i> Enviar Confirma√ß√£o via WhatsApp
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">N√∫mero do Cliente:</label>
                        <input type="text" class="form-control" id="whatsappNumero" readonly>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mensagem:</label>
                        <textarea class="form-control" id="whatsappMessage" rows="15" readonly></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-success" id="btnEnviarWhatsApp">
                        <i class="fab fa-whatsapp"></i> Abrir WhatsApp
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Custom scripts -->
    <script>
        // Toggle the side navigation
        (function($) {
            "use strict";

            $("#sidebarToggle, #sidebarToggleTop").on('click', function(e) {
                $("body").toggleClass("sidebar-toggled");
                $(".sidebar").toggleClass("toggled");
                if ($(".sidebar").hasClass("toggled")) {
                    $('.sidebar .collapse').collapse('hide');
                }
            });

            $(window).resize(function() {
                if ($(window).width() < 768) {
                    $('.sidebar .collapse').collapse('hide');
                }
                
                if ($(window).width() < 480 && !$(".sidebar").hasClass("toggled")) {
                    $("body").addClass("sidebar-toggled");
                    $(".sidebar").addClass("toggled");
                    $('.sidebar .collapse').collapse('hide');
                }
            });

        })(jQuery);

        // Vari√°veis globais
        let pastelariaAPI;
        let todosPedidos = [];
        let pedidosFiltrados = [];
        let pedidoAtual = null;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            pastelariaAPI = new PastelariaAPI();
            carregarPedidos();
            
            // Definir data de hoje como padr√£o
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('filtroData').value = hoje;
        });

        // Fun√ß√£o para formatar data do pedido com tratamento de erro
        function formatarDataPedido(pedido) {
            try {
                const data = pedido.dataPedido || pedido.createdAt;
                if (!data) return 'Data n√£o informada';
                
                const dataObj = new Date(data);
                if (isNaN(dataObj.getTime())) {
                    return 'Data inv√°lida';
                }
                
                return dataObj.toLocaleString('pt-BR');
            } catch (error) {
                console.error('Erro ao formatar data:', error, pedido);
                return 'Erro na data';
            }
        }

        // Carregar pedidos da API
        async function carregarPedidos() {
            try {
                document.getElementById('loading').style.display = 'block';
                document.getElementById('pedidosContainer').style.display = 'none';
                document.getElementById('noPedidos').style.display = 'none';

                const response = await pastelariaAPI.getPedidos();
                todosPedidos = response.data || response; // Suporte para ambos os formatos
                pedidosFiltrados = [...todosPedidos];
                
                filtrarPedidos();
                
            } catch (error) {
                console.error('Erro ao carregar pedidos:', error);
                document.getElementById('loading').style.display = 'none';
                document.getElementById('noPedidos').style.display = 'block';
                document.querySelector('#noPedidos h5').textContent = 'Erro ao carregar pedidos';
                document.querySelector('#noPedidos p').textContent = 'Ocorreu um erro ao buscar os pedidos. Tente novamente.';
            }
        }

        // Filtrar pedidos
        function filtrarPedidos() {
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroData = document.getElementById('filtroData').value;
            const filtroCliente = document.getElementById('filtroCliente').value.toLowerCase();

            pedidosFiltrados = todosPedidos.filter(pedido => {
                // Filtro por status
                if (filtroStatus && pedido.status !== filtroStatus) {
                    return false;
                }

                // Filtro por data
                if (filtroData) {
                    try {
                        const data = pedido.dataPedido || pedido.createdAt;
                        if (data) {
                            const dataObj = new Date(data);
                            if (!isNaN(dataObj.getTime())) {
                                const dataPedido = dataObj.toISOString().split('T')[0];
                                if (dataPedido !== filtroData) {
                                    return false;
                                }
                            }
                        }
                    } catch (error) {
                        console.error('Erro ao filtrar por data:', error, pedido);
                        // Se houver erro na data, n√£o filtrar este pedido
                    }
                }

                // Filtro por cliente
                if (filtroCliente) {
                    // Obter nome do cliente para filtro de forma robusta
                    let nomeCliente = '';
                    if (pedido.cliente) {
                        if (typeof pedido.cliente === 'object' && pedido.cliente.nome) {
                            nomeCliente = pedido.cliente.nome.toLowerCase();
                        } else if (typeof pedido.cliente === 'string') {
                            nomeCliente = pedido.cliente.toLowerCase();
                        }
                    }
                    if (!nomeCliente.includes(filtroCliente)) {
                        return false;
                    }
                }

                return true;
            });

            exibirPedidos();
        }

        // Exibir pedidos na interface
        function exibirPedidos() {
            const container = document.getElementById('pedidosContainer');
            const loading = document.getElementById('loading');
            const noPedidos = document.getElementById('noPedidos');

            loading.style.display = 'none';

            if (pedidosFiltrados.length === 0) {
                container.style.display = 'none';
                noPedidos.style.display = 'block';
                return;
            }

            noPedidos.style.display = 'none';
            container.style.display = 'flex';
            container.innerHTML = '';

            // Ordenar por data (mais recentes primeiro)
            pedidosFiltrados.sort((a, b) => {
                const dataA = new Date(a.dataPedido || a.createdAt);
                const dataB = new Date(b.dataPedido || b.createdAt);
                return dataB - dataA;
            });

            pedidosFiltrados.forEach(pedido => {
                const card = criarCardPedido(pedido);
                container.appendChild(card);
            });
        }

        // Criar card do pedido
        function criarCardPedido(pedido) {
            const col = document.createElement('div');
            col.className = 'col-lg-6 col-xl-4 mb-4';

            const statusClass = getStatusClass(pedido.status);
            const statusText = getStatusText(pedido.status);
            
            // Obter nome do cliente de forma robusta
            let nomeCliente = 'Cliente n√£o informado';
            if (pedido.cliente) {
                if (typeof pedido.cliente === 'object' && pedido.cliente.nome) {
                    nomeCliente = pedido.cliente.nome;
                } else if (typeof pedido.cliente === 'string') {
                    nomeCliente = pedido.cliente;
                }
            }
            
            const telefoneCliente = pedido.cliente?.telefone || pedido.telefone || '';

            // Formata√ß√£o dos itens
            const itensHtml = pedido.itens.map(item => {
                const sabores = item.sabor ? ` - ${item.sabor}` : '';
                // Usar precoUnitario se dispon√≠vel, sen√£o usar preco
                const preco = item.precoUnitario || item.preco || 0;
                const quantidade = item.quantidade || 1;
                const subtotalItem = (preco * quantidade);
                return `<div class="order-items">
                    ${quantidade}x ${item.produto}${sabores} (${item.tamanho})
                    <span class="float-end">R$ ${subtotalItem.toFixed(2).replace('.', ',')}</span>
                </div>`;
            }).join('');

            // Bot√µes de a√ß√£o baseados no status
            const botoesAcao = criarBotoesAcao(pedido);

            col.innerHTML = `
                <div class="card order-card ${pedido.status.toLowerCase()} shadow h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">
                            Pedido #${pedido.numero || pedido.id.toString().slice(-6)}
                        </h6>
                        <span class="badge ${statusClass} status-badge">${statusText}</span>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong><i class="fas fa-user"></i> ${nomeCliente}</strong>
                            ${telefoneCliente ? `<br><small class="text-muted"><i class="fas fa-phone"></i> ${telefoneCliente}</small>` : ''}
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-map-marker-alt"></i> ${pedido.endereco}
                            </small>
                        </div>
                        <div class="mb-2">
                            <small class="text-muted">
                                <i class="fas fa-clock"></i> ${formatarDataPedido(pedido)}
                            </small>
                        </div>
                        <div class="mb-3">
                            ${itensHtml}
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <span><strong>Total: R$ ${(pedido.total || 0).toFixed(2).replace('.', ',')}</strong></span>
                            <small class="text-muted">${pedido.formaPagamento || 'N/I'}</small>
                        </div>
                        <div class="d-flex flex-wrap justify-content-center">
                            ${botoesAcao}
                        </div>
                    </div>
                </div>
            `;

            return col;
        }

        // Criar bot√µes de a√ß√£o baseados no status
        function criarBotoesAcao(pedido) {
            let botoes = '';

            // Bot√£o de imprimir comanda (sempre dispon√≠vel, exceto cancelado)
            if (pedido.status !== 'Cancelado') {
                botoes += `<button class="btn btn-info btn-sm btn-action" onclick="imprimirComanda('${pedido.id}')" title="Imprimir Comanda">
                    <i class="fas fa-print"></i>
                </button>`;
            }

            // Bot√µes de mudan√ßa de status
            switch (pedido.status) {
                case 'Pendente':
                    botoes += `<button class="btn btn-warning btn-sm btn-action" onclick="alterarStatus('${pedido.id}', 'Preparando')" title="Marcar como Preparando">
                        <i class="fas fa-clock"></i>
                    </button>`;
                    botoes += `<button class="btn btn-danger btn-sm btn-action" onclick="alterarStatus('${pedido.id}', 'Cancelado')" title="Cancelar Pedido">
                        <i class="fas fa-times"></i>
                    </button>`;
                    break;
                case 'Preparando':
                    botoes += `<button class="btn btn-info btn-sm btn-action" onclick="alterarStatus('${pedido.id}', 'Pronto')" title="Marcar como Pronto">
                        <i class="fas fa-check"></i>
                    </button>`;
                    break;
                case 'Pronto':
                    botoes += `<button class="btn btn-success btn-sm btn-action" onclick="alterarStatus('${pedido.id}', 'Entregue')" title="Marcar como Entregue">
                        <i class="fas fa-truck"></i>
                    </button>`;
                    botoes += `<button class="btn btn-primary btn-sm btn-action" onclick="enviarConfirmacaoWhatsApp('${pedido.id}')" title="Enviar Confirma√ß√£o WhatsApp">
                        <i class="fab fa-whatsapp"></i>
                    </button>`;
                    break;
            }

            return botoes;
        }

        // Alterar status do pedido
        async function alterarStatus(pedidoId, novoStatus) {
            const pedido = todosPedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            const mensagens = {
                'Preparando': 'Marcar pedido como "Preparando"?',
                'Pronto': 'Marcar pedido como "Pronto"?',
                'Entregue': 'Marcar pedido como "Entregue"?',
                'Cancelado': 'Cancelar este pedido?'
            };

            document.getElementById('confirmMessage').textContent = mensagens[novoStatus];
            
            const modal = new bootstrap.Modal(document.getElementById('confirmModal'));
            modal.show();

            document.getElementById('confirmButton').onclick = async function() {
                try {
                    await pastelariaAPI.atualizarStatusPedido(pedidoId, novoStatus);
                    
                    // Atualizar localmente
                    pedido.status = novoStatus;
                    
                    // Recarregar a exibi√ß√£o
                    filtrarPedidos();
                    
                    modal.hide();
                    
                    // Mostrar notifica√ß√£o de sucesso
                    mostrarNotificacao('Status atualizado com sucesso!', 'success');
                    
                } catch (error) {
                    console.error('Erro ao atualizar status:', error);
                    mostrarNotificacao('Erro ao atualizar status do pedido', 'error');
                }
            };
        }

        // Imprimir comanda da cozinha
        function imprimirComanda(pedidoId) {
            const pedido = todosPedidos.find(p => p.id === pedidoId);
            if (!pedido) return;

            imprimirComandaCozinha(pedido);
        }

        // Fun√ß√£o para imprimir comanda da cozinha
        function imprimirComandaCozinha(pedido) {
            const dataFormatada = formatarDataPedido(pedido);
            
            // Obter dados do cliente de forma mais robusta
            let nomeCliente = 'Cliente n√£o informado';
            let telefoneCliente = '';
            let enderecoCliente = 'Endere√ßo n√£o informado';
            
            if (pedido.cliente) {
                if (typeof pedido.cliente === 'object') {
                    nomeCliente = pedido.cliente.nome || 'Cliente n√£o informado';
                    telefoneCliente = pedido.cliente.telefone || '';
                    enderecoCliente = pedido.cliente.endereco || 'Endere√ßo n√£o informado';
                } else if (typeof pedido.cliente === 'string') {
                    nomeCliente = pedido.cliente;
                }
            }
            
            // Fallback para campos diretos no pedido
            if (!telefoneCliente && pedido.telefone) {
                telefoneCliente = pedido.telefone;
            }
            if (enderecoCliente === 'Endere√ßo n√£o informado' && pedido.endereco) {
                enderecoCliente = pedido.endereco;
            }
            
            let comandaHtml = `
                <div style="font-family: 'Courier New', monospace; font-size: 12px; line-height: 1.2; max-width: 300px; margin: 0 auto;">
                    <div style="text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 15px;">
                        <h2 style="margin: 0; font-size: 16px; font-weight: bold;">SABOR EXPRESS</h2>
                        <h3 style="margin: 5px 0; font-size: 14px;">COMANDA DA COZINHA</h3>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                            <span><strong>PEDIDO No:</strong> ${pedido.numero || pedido.id.toString().slice(-6)}</span>
                            <span><strong>STATUS:</strong> ${pedido.status.toUpperCase()}</span>
                        </div>
                        <div><strong>DATA/HORA:</strong> ${dataFormatada}</div>
                        <div><strong>CLIENTE:</strong> ${nomeCliente}</div>
                        ${telefoneCliente ? `<div><strong>TELEFONE:</strong> ${telefoneCliente}</div>` : ''}
                    </div>
                    
                    <div style="border-top: 1px solid #000; border-bottom: 1px solid #000; padding: 10px 0; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 10px 0; text-align: center; font-size: 14px;">ITENS DO PEDIDO</h4>
            `;
            
            pedido.itens.forEach((item, index) => {
                const sabores = item.sabor ? item.sabor : 'N/A';
                comandaHtml += `
                    <div style="margin-bottom: 10px; padding: 5px; border: 1px dashed #666;">
                        <div style="font-weight: bold; font-size: 13px;">${index + 1}. ${item.produto}</div>
                        <div style="margin-left: 10px;">
                            <div><strong>Sabor:</strong> ${sabores}</div>
                            <div><strong>Tamanho:</strong> ${item.tamanho}</div>
                            <div><strong>Quantidade:</strong> ${item.quantidade}x</div>
                        </div>
                    </div>
                `;
            });
            
            comandaHtml += `
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 10px; border-top: 2px solid #000;">
                        <div style="font-size: 14px; font-weight: bold;">TOTAL: R$ ${(pedido.total || 0).toFixed(2).replace('.', ',')}</div>
                        <div style="font-size: 12px; margin-top: 5px;">Pagamento: ${pedido.formaPagamento || 'N/I'}</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 15px; font-size: 10px;">
                        <div>${enderecoCliente}</div>
                        <div style="margin-top: 10px;">Impresso em: ${new Date().toLocaleString('pt-BR')}</div>
                    </div>
                    
                    <div style="text-align: center; margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px;">
                        <div style="font-size: 11px;">
                            <div>ATENCAO COZINHA</div>
                            <div>Verificar todos os ingredientes</div>
                            <div>Conferir sabores e tamanhos</div>
                        </div>
                    </div>
                </div>
            `;
            
            // Criar nova janela para impress√£o
            const janelaImpressao = window.open('', '_blank', 'width=400,height=600');
            janelaImpressao.document.write(
                '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '<title>Comanda da Cozinha - Pedido ' + (pedido.numero || pedido.id.toString().slice(-6)) + '</title>' +
                '<style>' +
                '@media print {' +
                'body { margin: 0; }' +
                '@page { margin: 10mm; }' +
                '}' +
                'body {' +
                'font-family: "Courier New", monospace;' +
                'font-size: 12px;' +
                'line-height: 1.4;' +
                'margin: 0;' +
                'padding: 10px;' +
                'background: white;' +
                '}' +
                '</style>' +
                '</head>' +
                '<body>' +
                comandaHtml +
                '<scr' + 'ipt>' +
                'window.onload = function() {' +
                'window.print();' +
                'setTimeout(function() {' +
                'window.close();' +
                '}, 1000);' +
                '}' +
                '</scr' + 'ipt>' +
                '</body>' +
                '</html>'
            );
            janelaImpressao.document.close();
        }

        // Fun√ß√£o para gerar mensagem do WhatsApp
        function gerarMensagemWhatsApp(pedido) {
            if (!pedido) return;

            // Obter dados do cliente de forma mais robusta
            let nomeCliente = 'Cliente n√£o informado';
            let telefoneCliente = '';
            let enderecoCliente = 'Endere√ßo n√£o informado';
            
            // Verificar diferentes estruturas de dados do cliente
            if (pedido.cliente) {
                if (typeof pedido.cliente === 'object') {
                    nomeCliente = pedido.cliente.nome || 'Cliente n√£o informado';
                    telefoneCliente = pedido.cliente.telefone || '';
                    enderecoCliente = pedido.cliente.endereco || pedido.endereco || 'Endere√ßo n√£o informado';
                } else if (typeof pedido.cliente === 'string') {
                    nomeCliente = pedido.cliente;
                }
            }
            
            // Fallback para campos diretos no pedido
            if (!telefoneCliente && pedido.telefone) {
                telefoneCliente = pedido.telefone;
            }
            if (enderecoCliente === 'Endere√ßo n√£o informado' && pedido.endereco) {
                enderecoCliente = pedido.endereco;
            }
            
            const formaPagamento = pedido.formaPagamento || 'PIX';
            
            // Calcular subtotal dos itens
            let subtotalItens = 0;
            let itensTexto = '';
            
            pedido.itens.forEach((item, index) => {
                // Usar precoUnitario se dispon√≠vel, sen√£o usar preco
                let preco = 0;
                if (item.precoUnitario !== undefined && item.precoUnitario !== null) {
                    preco = parseFloat(item.precoUnitario);
                } else if (item.preco !== undefined && item.preco !== null) {
                    preco = parseFloat(item.preco);
                } else if (item.precoTotal && item.quantidade) {
                    preco = parseFloat(item.precoTotal) / parseFloat(item.quantidade);
                }
                
                const quantidade = parseInt(item.quantidade) || 1;
                const subtotalItem = quantidade * preco;
                subtotalItens += subtotalItem;
                
                // Obter sabores corretamente
                let saboresTexto = '';
                if (item.sabores && Array.isArray(item.sabores) && item.sabores.length > 0) {
                    const saboresNomes = item.sabores.map(sabor => {
                        if (typeof sabor === 'object' && sabor.nome) {
                            return sabor.nome;
                        } else if (typeof sabor === 'string') {
                            return sabor;
                        }
                        return '';
                    }).filter(nome => nome);
                    
                    if (saboresNomes.length > 0) {
                        saboresTexto = ` - ${saboresNomes.join(', ')}`;
                    }
                } else if (item.sabor) {
                    saboresTexto = ` - ${item.sabor}`;
                }
                
                const tamanhoInfo = item.tamanho ? ` (${item.tamanho})` : '';
                
                // Obter nome do produto corretamente
                let nomeProduto = 'Produto n√£o informado';
                if (item.produtoNome) {
                    nomeProduto = item.produtoNome;
                } else if (item.produto) {
                    if (typeof item.produto === 'object' && item.produto.nome) {
                        nomeProduto = item.produto.nome;
                    } else if (typeof item.produto === 'string') {
                        nomeProduto = item.produto;
                    }
                }
                
                itensTexto += `${index + 1}. ${nomeProduto}${saboresTexto}${tamanhoInfo}\n`;
                itensTexto += `   Qtd: ${quantidade}x R$ ${preco.toFixed(2).replace('.', ',')}\n`;
                itensTexto += `   Subtotal: R$ ${subtotalItem.toFixed(2).replace('.', ',')}\n\n`;
            });
            
            // Calcular taxa de delivery
            const taxaEntrega = pedido.taxaEntrega || pedido.taxaDelivery || 5.00;
            const total = pedido.total || (subtotalItens + taxaEntrega);
            
            const dataFormatada = formatarDataPedido(pedido);
            
            const mensagem = `üçï *PEDIDO #${pedido.numero || 'N/A'}*\n\n` +
                           `üë§ *Cliente:* ${nomeCliente}\n` +
                           `üìû *Telefone:* ${telefoneCliente}\n` +
                           `üìç *Endere√ßo:* ${enderecoCliente}\n` +
                           `üí≥ *Pagamento:* ${formaPagamento}\n\n` +
                           `üìã *Itens:*\n${itensTexto}` +
                           `üí∞ *Subtotal:* R$ ${subtotalItens.toFixed(2).replace('.', ',')}\n` +
                           `üöö *Taxa de Entrega:* R$ ${taxaEntrega.toFixed(2).replace('.', ',')}\n` +
                           `üíµ *Total:* R$ ${total.toFixed(2).replace('.', ',')}\n\n` +
                           `üìÖ *Data:* ${dataFormatada}\n\n` +
                           `Obrigado pela prefer√™ncia! üçï‚ú®`;

            // Mostrar modal com a mensagem
            document.getElementById('whatsappMessage').textContent = mensagem;
            document.getElementById('whatsappNumero').value = telefoneCliente;
            
            // Usar Bootstrap para mostrar o modal
            const modal = new bootstrap.Modal(document.getElementById('whatsappModal'));
            modal.show();
            
            // Preparar link do WhatsApp
            const numeroWhatsApp = telefoneCliente.replace(/\D/g, ''); // Remove caracteres n√£o num√©ricos
            const mensagemCodificada = encodeURIComponent(mensagem);
            const linkWhatsApp = `https://wa.me/55${numeroWhatsApp}?text=${mensagemCodificada}`;
            
            // Atualizar bot√£o de envio
            const btnEnviar = document.getElementById('btnEnviarWhatsApp');
            btnEnviar.onclick = function() {
                window.open(linkWhatsApp, '_blank');
                modal.hide();
            };
        }

        // Fun√ß√£o para chamar a gera√ß√£o de mensagem WhatsApp
        function enviarConfirmacaoWhatsApp(pedidoId) {
            const pedido = todosPedidos.find(p => p.id === pedidoId);
            if (!pedido) return;
            
            gerarMensagemWhatsApp(pedido);
        }

        // Fun√ß√µes auxiliares
        function getStatusClass(status) {
            const statusClasses = {
                'Pendente': 'bg-primary',
                'Preparando': 'bg-warning',
                'Pronto': 'bg-info',
                'Entregue': 'bg-success',
                'Cancelado': 'bg-danger'
            };
            return statusClasses[status] || 'bg-secondary';
        }

        function getStatusText(status) {
            const statusTexts = {
                'Pendente': 'Novo',
                'Preparando': 'Preparando',
                'Pronto': 'Pronto',
                'Entregue': 'Entregue',
                'Cancelado': 'Cancelado'
            };
            return statusTexts[status] || status;
        }

        function mostrarNotificacao(mensagem, tipo) {
            // Criar elemento de notifica√ß√£o
            const notificacao = document.createElement('div');
            notificacao.className = `alert alert-${tipo === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
            notificacao.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            notificacao.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;

            document.body.appendChild(notificacao);

            // Remover ap√≥s 5 segundos
            setTimeout(() => {
                if (notificacao.parentNode) {
                    notificacao.parentNode.removeChild(notificacao);
                }
            }, 5000);
        }
    </script>
</body>
</html>
